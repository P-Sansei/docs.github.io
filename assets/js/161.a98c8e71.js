(window.webpackJsonp=window.webpackJsonp||[]).push([[161],{374:function(s,a,e){"use strict";e.r(a);var t=e(2),n=Object(t.a)({},function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"kubernetes-统一环境配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubernetes-统一环境配置","aria-hidden":"true"}},[s._v("#")]),s._v(" Kubernetes 统一环境配置")]),s._v(" "),e("h2",{attrs:{id:"单独节点配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#单独节点配置","aria-hidden":"true"}},[s._v("#")]),s._v(" 单独节点配置")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：为 Master 和 Node 节点单独配置对应的 "),e("strong",[s._v("IP")]),s._v(" 和 "),e("strong",[s._v("主机名")])])]),s._v(" "),e("h3",{attrs:{id:"配置-ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置-ip","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置 IP")]),s._v(" "),e("p",[s._v("编辑 "),e("code",[s._v("vi /etc/netplan/50-cloud-init.yaml")]),s._v(" 配置文件，修改内容如下")]),s._v(" "),e("p",[e("strong",[s._v("默认配置")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("network:\n    ethernets:\n        ens33:\n            dhcp4: "),e("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),s._v("\n    version: 2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("p",[e("strong",[s._v("修改为如下配置")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("network")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ethernets")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ens33")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 我的 Master 是 150 - 152，Node 是 160 - 162")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.141.150/24"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("gateway4")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.141.2\n          "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nameservers")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("addresses")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("192.168.141.2"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("p",[s._v("使用 "),e("code",[s._v("netplan apply")]),s._v(" 命令让配置生效")]),s._v(" "),e("h3",{attrs:{id:"配置主机名"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置主机名","aria-hidden":"true"}},[s._v("#")]),s._v(" 配置主机名")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改主机名")]),s._v("\nhostnamectl set-hostname kubernetes-master-01\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 hosts")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n192.168.141.150 kubernetes-master-01\nEOF")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /etc/hosts "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("EOF\n192.168.141.160 kubernetes-node-01\nEOF")]),s._v("\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br")])]),e("h2",{attrs:{id:"安装-haproxy-keepalived"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装-haproxy-keepalived","aria-hidden":"true"}},[s._v("#")]),s._v(" 安装 HAProxy + Keepalived")]),s._v(" "),e("h3",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述","aria-hidden":"true"}},[s._v("#")]),s._v(" 概述")]),s._v(" "),e("p",[s._v("Kubernetes Master 节点运行组件如下：")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("kube-apiserver：")]),s._v(" 提供了资源操作的唯一入口，并提供认证、授权、访问控制、API 注册和发现等机制")]),s._v(" "),e("li",[e("strong",[s._v("kube-scheduler：")]),s._v(" 负责资源的调度，按照预定的调度策略将 Pod 调度到相应的机器上")]),s._v(" "),e("li",[e("strong",[s._v("kube-controller-manager：")]),s._v(" 负责维护集群的状态，比如故障检测、自动扩展、滚动更新等")]),s._v(" "),e("li",[e("strong",[s._v("etcd：")]),s._v(" CoreOS 基于 Raft 开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）")])]),s._v(" "),e("p",[e("code",[s._v("kube-scheduler")]),s._v(" 和 "),e("code",[s._v("kube-controller-manager")]),s._v(" 可以以集群模式运行，通过 leader 选举产生一个工作进程，其它进程处于阻塞模式。")]),s._v(" "),e("p",[e("strong",[s._v("kube-apiserver 可以运行多个实例，但对其它组件需要提供统一的访问地址，本章节部署 Kubernetes 高可用集群实际就是利用 HAProxy + Keepalived 配置该组件")])]),s._v(" "),e("p",[s._v("配置的思路就是利用 HAProxy + Keepalived 实现 "),e("code",[s._v("kube-apiserver")]),s._v(" 虚拟 IP 访问从而实现高可用和负载均衡，拆解如下：")]),s._v(" "),e("ul",[e("li",[s._v("Keepalived 提供 "),e("code",[s._v("kube-apiserver")]),s._v(" 对外服务的虚拟 IP（VIP）")]),s._v(" "),e("li",[s._v("HAProxy 监听 Keepalived VIP")]),s._v(" "),e("li",[s._v("运行 Keepalived 和 HAProxy 的节点称为 LB（负载均衡） 节点")]),s._v(" "),e("li",[s._v("Keepalived 是一主多备运行模式，故至少需要两个 LB 节点")]),s._v(" "),e("li",[s._v("Keepalived 在运行过程中周期检查本机的 HAProxy 进程状态，如果检测到 HAProxy 进程异常，则触发重新选主的过程，VIP 将飘移到新选出来的主节点，从而实现 VIP 的高可用")]),s._v(" "),e("li",[s._v("所有组件（如 kubeclt、apiserver、controller-manager、scheduler 等）都通过 VIP +HAProxy 监听的 6444 端口访问 "),e("code",[s._v("kube-apiserver")]),s._v(" 服务（"),e("strong",[s._v("注意：kube-apiserver 默认端口为 6443，为了避免冲突我们将 HAProxy 端口设置为 6444，其它组件都是通过该端口统一请求 apiserver")]),s._v("）")])]),s._v(" "),e("h3",{attrs:{id:"创建-haproxy-启动脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-haproxy-启动脚本","aria-hidden":"true"}},[s._v("#")]),s._v(" 创建 HAProxy 启动脚本")]),s._v(" "),e("blockquote",[e("p",[s._v("该步骤在 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/local/kubernetes/lb/start-haproxy.sh\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入内容如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为你自己的 Master 地址")]),s._v("\nMasterIP1"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("192.168.141.150\nMasterIP2"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("192.168.141.151\nMasterIP3"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("192.168.141.152\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 这是 kube-apiserver 默认端口，不用修改")]),s._v("\nMasterPort"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("6443\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 容器将 HAProxy 的 6444 端口暴露出去")]),s._v("\ndocker run -d --restart"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name HAProxy-K8S -p 6444:6444 \\\n        -e MasterIP1"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP1")]),s._v(" \\\n        -e MasterIP2"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP2")]),s._v(" \\\n        -e MasterIP3"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterIP3")]),s._v(" \\\n        -e MasterPort"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MasterPort")]),s._v(" \\\n        wise2c/haproxy-k8s\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x start-haproxy.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br")])]),e("h3",{attrs:{id:"创建-keepalived-启动脚本"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建-keepalived-启动脚本","aria-hidden":"true"}},[s._v("#")]),s._v(" 创建 Keepalived 启动脚本")]),s._v(" "),e("blockquote",[e("p",[s._v("该步骤在 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 执行")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /usr/local/kubernetes/lb/start-keepalived.sh\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输入内容如下")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/bash")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为你自己的虚拟 IP 地址")]),s._v("\nVIRTUAL_IP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("192.168.141.200\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡设备名")]),s._v("\nINTERFACE"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("ens33\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟网卡的子网掩码")]),s._v("\nNETMASK_BIT"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("24\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# HAProxy 暴露端口，内部指向 kube-apiserver 的 6443 端口")]),s._v("\nCHECK_PORT"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("6444\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 路由标识符")]),s._v("\nRID"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("10\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 虚拟路由标识符")]),s._v("\nVRID"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("160\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# IPV4 多播地址，默认 224.0.0.18")]),s._v("\nMCAST_GROUP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("224.0.0.18\n\ndocker run -itd --restart"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("always --name"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("Keepalived-K8S \\\n        --net"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("host --cap-add"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("NET_ADMIN \\\n        -e VIRTUAL_IP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VIRTUAL_IP")]),s._v(" \\\n        -e INTERFACE"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$INTERFACE")]),s._v(" \\\n        -e CHECK_PORT"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$CHECK_PORT")]),s._v(" \\\n        -e RID"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$RID")]),s._v(" \\\n        -e VRID"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$VRID")]),s._v(" \\\n        -e NETMASK_BIT"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$NETMASK_BIT")]),s._v(" \\\n        -e MCAST_GROUP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$MCAST_GROUP")]),s._v(" \\\n        wise2c/keepalived-k8s\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 设置权限")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" +x start-keepalived.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br")])]),e("h3",{attrs:{id:"复制脚本到其它-master-地址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#复制脚本到其它-master-地址","aria-hidden":"true"}},[s._v("#")]),s._v(" 复制脚本到其它 Master 地址")]),s._v(" "),e("p",[s._v("分别在 "),e("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),e("code",[s._v("kubernetes-master-03")]),s._v(" 执行创建工作目录命令")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/lb\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("将 "),e("code",[s._v("kubernetes-master-01")]),s._v(" 中的脚本拷贝至其它 Master")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" start-haproxy.sh start-keepalived.sh 192.168.141.151:/usr/local/kubernetes/lb\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("scp")]),s._v(" start-haproxy.sh start-keepalived.sh 192.168.141.152:/usr/local/kubernetes/lb\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("分别在 3 个 Master 中启动容器（执行脚本）")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("sh /usr/local/kubernetes/lb/start-haproxy.sh "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" sh /usr/local/kubernetes/lb/start-keepalived.sh\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"验证是否成功"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证是否成功","aria-hidden":"true"}},[s._v("#")]),s._v(" 验证是否成功")]),s._v(" "),e("h4",{attrs:{id:"查看容器"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看容器","aria-hidden":"true"}},[s._v("#")]),s._v(" 查看容器")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("docker "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ps")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\nCONTAINER ID        IMAGE                   COMMAND                  CREATED             STATUS              PORTS                    NAMES\nf50df479ecae        wise2c/keepalived-k8s   "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/bin/keepalived…"')]),s._v("   About an hour ago   Up About an hour                             Keepalived-K8S\n75066a7ed2fb        wise2c/haproxy-k8s      "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/docker-entrypoint.…"')]),s._v("   About an hour ago   Up About an hour    0.0.0.0:6444-"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("6\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h4",{attrs:{id:"查看网卡绑定的虚拟-ip"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看网卡绑定的虚拟-ip","aria-hidden":"true"}},[s._v("#")]),s._v(" 查看网卡绑定的虚拟 IP")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ens33\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\n2: ens33: "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    inet 192.168.141.151/24 brd 192.168.141.255 scope global ens33\n    inet 192.168.141.200/24 scope global secondary ens33\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("blockquote",[e("p",[s._v("特别注意：Keepalived 会对 HAProxy 监听的 6444 端口进行检测，如果检测失败即认定本机 HAProxy 进程异常，会将 VIP 漂移到其他节点，所以无论本机 Keepalived 容器异常或 HAProxy 容器异常都会导致 VIP 漂移到其他节点")])]),s._v(" "),e("h3",{attrs:{id:"初始化-master"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#初始化-master","aria-hidden":"true"}},[s._v("#")]),s._v(" 初始化 Master")]),s._v(" "),e("ul",[e("li",[s._v("创建工作目录并导出配置文件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 创建工作目录")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p /usr/local/kubernetes/cluster\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 导出配置文件到工作目录")]),s._v("\nkubeadm config print init-defaults --kubeconfig ClusterConfiguration "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" kubeadm.yml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ul",[e("li",[s._v("修改配置文件")])]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeadm.k8s.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bootstrapTokens")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("groups")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" system"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("bootstrappers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("kubeadm"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("default"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("token\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("token")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" abcdef.0123456789abcdef\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ttl")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 24h0m0s\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("usages")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" signing\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" authentication\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" InitConfiguration\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("localAPIEndpoint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改为主节点 IP")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("advertiseAddress")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 192.168.141.150\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("bindPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("6443")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nodeRegistration")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("criSocket")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/run/dockershim.sock\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("master"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("01")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("taints")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("effect")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" NoSchedule\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("role.kubernetes.io/master\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiServer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("timeoutForControlPlane")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 4m0s\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeadm.k8s.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("certificatesDir")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /etc/kubernetes/pki\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("clusterName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubernetes\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 Keepalived 地址和 HAProxy 端口")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("controlPlaneEndpoint")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"192.168.141.200:6444"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("controllerManager")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dns")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("type")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" CoreDNS\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("etcd")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("local")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dataDir")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /var/lib/etcd\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 国内不能访问 Google，修改为阿里云")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("imageRepository")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" registry.aliyuncs.com/google_containers\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ClusterConfiguration\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改版本号")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kubernetesVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1.14.3\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("networking")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("dnsDomain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" cluster.local\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 主要修改在这里，替换 Calico 网段为我们虚拟机不重叠的网段（这里用的是 Flannel 默认网段）")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("podSubnet")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"10.244.0.0/16"')]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("serviceSubnet")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.96.0.0/12\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("scheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("---")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开启 IPVS 模式")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" kubeproxy.config.k8s.io/v1alpha1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" KubeProxyConfiguration\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("featureGates")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("SupportIPVSProxyMode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[s._v("true")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("mode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ipvs\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br")])]),e("ul",[e("li",[s._v("kubeadm 初始化")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# kubeadm 初始化")]),s._v("\nkubeadm init --config"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("kubeadm.yml --experimental-upload-certs "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("tee")]),s._v(" kubeadm-init.log\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 配置 kubectl")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" -p "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.kube\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cp")]),s._v(" -i /etc/kubernetes/admin.conf "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.kube/config\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chown")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -u"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("id")]),s._v(" -g"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v(" "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.kube/config\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证是否成功")]),s._v("\nkubectl get node\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("ul",[e("li",[s._v("安装网络插件")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 Calico 配置文件并修改")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://docs.projectcalico.org/v3.7/manifests/calico.yaml\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" calico.yaml\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 修改第 611 行，将 192.168.0.0/16 修改为 10.244.0.0/16，可以通过如下命令快速查找")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 显示行号：:set number")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查找字符：/要查找的字符，输入小写 n 下一个匹配项，输入大写 N 上一个匹配项")]),s._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 安装 Calico")]),s._v("\nkubectl apply -f calico.yaml\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\nconfigmap/calico-config created\ncustomresourcedefinition.apiextensions.k8s.io/felixconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamblocks.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/blockaffinities.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamhandles.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ipamconfigs.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgppeers.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/bgpconfigurations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/ippools.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/hostendpoints.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/clusterinformations.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/globalnetworksets.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networkpolicies.crd.projectcalico.org created\ncustomresourcedefinition.apiextensions.k8s.io/networksets.crd.projectcalico.org created\nclusterrole.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrolebinding.rbac.authorization.k8s.io/calico-kube-controllers created\nclusterrole.rbac.authorization.k8s.io/calico-node created\nclusterrolebinding.rbac.authorization.k8s.io/calico-node created\ndaemonset.extensions/calico-node created\nserviceaccount/calico-node created\ndeployment.extensions/calico-kube-controllers created\nserviceaccount/calico-kube-controllers created\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 验证安装是否成功")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("watch")]),s._v(" kubectl get pods --all-namespaces\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br")])]),e("h3",{attrs:{id:"加入-master-节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入-master-节点","aria-hidden":"true"}},[s._v("#")]),s._v(" 加入 Master 节点")]),s._v(" "),e("p",[s._v("从 "),e("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),e("code",[s._v("kubernetes-master-02")]),s._v(" 和 "),e("code",[s._v("kubernetes-master-03")]),s._v(" 加入 Master")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下为示例命令")]),s._v("\nkubeadm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" 192.168.141.200:6444 --token abcdef.0123456789abcdef \\\n  --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f \\\n  --experimental-control-plane --certificate-key c4d1525b6cce4b69c11c18919328c826f92e660e040a46f5159431d5ff0545bd\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"加入-node-节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#加入-node-节点","aria-hidden":"true"}},[s._v("#")]),s._v(" 加入 Node 节点")]),s._v(" "),e("p",[s._v("从 "),e("code",[s._v("kubeadm-init.log")]),s._v(" 中获取命令，分别将 "),e("code",[s._v("kubernetes-node-01")]),s._v(" 至 "),e("code",[s._v("kubernetes-node-03")]),s._v(" 加入 Node")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下为示例命令")]),s._v("\nkubeadm "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("join")]),s._v(" 192.168.141.200:6444 --token abcdef.0123456789abcdef \\\n    --discovery-token-ca-cert-hash sha256:56d53268517c132ae81c868ce99c44be797148fb2923e59b49d73c99782ff21f \n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"验证集群状态"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证集群状态","aria-hidden":"true"}},[s._v("#")]),s._v(" 验证集群状态")]),s._v(" "),e("ul",[e("li",[e("p",[s._v("查看 Node")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get nodes -o wide\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查看 Pod")])])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get pod -o wide\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("查看 Service")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get svc\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[e("p",[s._v("验证 IPVS")]),s._v(" "),e("p",[s._v("查看 kube-proxy 日志，server_others.go:176] Using ipvs Proxier.")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system logs -f "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("kube-proxy 容器名"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])]),s._v(" "),e("li",[e("p",[s._v("查看代理规则")])])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("ipvsadm -ln\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("查看生效的配置")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system get cm kubeadm-config -oyaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ul",[e("li",[s._v("查看 etcd 集群")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl -n kube-system "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("exec")]),s._v(" etcd-kubernetes-master-01 -- etcdctl \\\n\t--endpoints"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("https://192.168.141.150:2379 \\\n\t--ca-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/ca.crt \\\n\t--cert-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.crt \\\n\t--key-file"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/kubernetes/pki/etcd/server.key cluster-health\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\nmember 1dfaf07371bb0cb6 is healthy: got healthy result from https://192.168.141.152:2379\nmember 2da85730b52fbeb2 is healthy: got healthy result from https://192.168.141.150:2379\nmember 6a3153eb4faaaffa is healthy: got healthy result from https://192.168.141.151:2379\ncluster is healthy\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("h3",{attrs:{id:"验证高可用"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#验证高可用","aria-hidden":"true"}},[s._v("#")]),s._v(" 验证高可用")]),s._v(" "),e("blockquote",[e("p",[s._v("特别注意：Keepalived 要求至少 2 个备用节点，故想测试高可用至少需要 1 主 2 从模式验证，否则可能出现意想不到的问题")])]),s._v(" "),e("p",[s._v("对任意一台 Master 机器执行关机操作")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),s._v(" -h now\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("在任意一台 Master 节点上查看 Node 状态")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("kubectl get node\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下，除已关机那台状态为 NotReady 其余正常便表示成功")]),s._v("\nNAME                   STATUS   ROLES    AGE   VERSION\nkubernetes-master-01   NotReady master   18m   v1.14.2\nkubernetes-master-02   Ready    master   17m   v1.14.2\nkubernetes-master-03   Ready    master   16m   v1.14.2\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("查看 VIP 漂移")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("ip")]),s._v(" a "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("grep")]),s._v(" ens33\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 输出如下")]),s._v("\n2: ens33: "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("BROADCAST,MULTICAST,UP,LOWER_UP"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    inet 192.168.141.151/24 brd 192.168.141.255 scope global ens33\n    inet 192.168.141.200/24 scope global secondary ens33\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])])])},[],!1,null,null,null);a.default=n.exports}}]);